<style>
    .contact-info-form {
        list-style-type: none;
        margin: 30px 0;
        padding: 0;
    }

        .contact-info-form li {
            margin: 10px 0;
        }

        .contact-info-form label {
            display: inline-block;
            width: 100px;
            text-align: right;
            font-weight: bold;
        }

    .history {
        width: 91%;
        margin-left: 75px;
    }

    th {
        text-align: center;
    }

    .red {
        color: red;
    }

    .green {
        color: green;
    }

    #hint {
        display: inline;
        margin-right: -174px;
        font-size: 14px;
    }

    .spinner_user {
        left: 48%;
        top: 56%;
        display: none;
    }

    .spinner_table {
        left: 48%;
        top: 131%;
        z-index: 9999;
        display: none;
    }
</style>


<div class="jumbotron text-center">
    <h3>Operations</h3>

    <div class="row">
        <div>
            <h3>Send PW</h3>
            <label>User  &nbsp;</label>
            <div class="spinner spinner_user"></div>
            <input type="search" id="recipient" /><span id="hint">*enter at least 3 characters</span>
            <br /><br />
            <input hidden="hidden" id="recipient_id" />
            <label>Sum &nbsp;</label>
            <input type="number" id="sum" /><br /><br />
            <input type="submit" value="OK" ng-click="passPWFunc()" />
        </div>
    </div>
    <br />
    <br />
    <div class="row">
        <div class="history">
            <h3>Operations History</h3>
            <table id="operations" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Sum</th>
                        <th><span class="green">Debit</span>/<span class="red">Credit</span></th>
                        <th><span class="green">From</span>/<span class="red">To</span></th>
                        <th>Operation Date</th>
                    </tr>
                </thead>
                <div class="spinner spinner_table"></div>
                <tfoot>
                    <tr>
                        <th>Sum</th>
                        <th><span class="green">Debit</span>/<span class="red">Credit</span></th>
                        <th><span class="green">From</span>/<span class="red">To</span></th>
                        <th>Operation Date</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script>

    /////////////////////SEND PW BLOCK/////////////////////////////
    $(function () {
        $("#recipient").autocomplete({
            source: []
        });

        $("#recipient").keyup(function (event) {
            const term = $("#recipient").val();

            if (term.length === 3) {
                const users = getUsersNames(term);
                var collection = [];

                users.forEach(function (item, i, arr) {
                    collection.push(
                        {
                            "label": item.Name,
                            "value": item.Name,
                            "id": item.Id
                        });
                });

                $("#recipient").autocomplete({
                    source: collection,
                    change: function(event, ui) {
                        if (ui.item) {
                            $("#recipient_id").val(ui.item.id);
                        }
                    }
                });
            }
        });

        function getUsersNames(term) {
            $('.spinner_user').css("display", "block");
            var result;

            $.ajax({
                type: 'GET',
                url: baseUrl + '/api/Transaction/GetUsers?term=' + term,
                beforeSend: function (xhr) {
                    const token = sessionStorage.getItem(tokenKey);
                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                },
                async: false
            }).success(function (data) {
                $('.spinner_user').css("display", "none");
                result = JSON.parse(data);

            }).fail(function (data) {
                alert(JSON.parse(data.responseText).Message);
            });

            return result;
        }
    });

    function sentPW() {
        const recipient_id = $('#recipient_id').val();
        const sum = $('#sum').val();
        if (!recipient_id) {
            alert("You must select an existing user");
            return;
        }

        if (!sum || sum<=0) {
            alert("The sum must be > 0");
            return;
        }

        $('.spinner_table').css("display", "block");
        var result;
        const passData = {
            RecipientId: recipient_id,
            Sum: sum
        };
        $.ajax({
            type: 'POST',
            contentType: "application/json",
            data: JSON.stringify(passData),
            url: baseUrl + '/api/Transaction/PostTransactionLog',
            async: false,
            beforeSend: function (xhr) {
                const token = sessionStorage.getItem(tokenKey);
                xhr.setRequestHeader("Authorization", "Bearer " + token);
            }
        }).success(function (data) {
            $('.spinner_table').css("display", "none");
            alert("PW sent successfully");
            result = data;

        }).fail(function (data) {
            alert(JSON.parse(data.responseText).Message);
            result = false;
        });

        return result;
    }

    /////////////////////SHOW OPERATIONS BLOCK////////////////////
    var dataTable = getLogs();

    var table =  $('#operations').DataTable(
        {
            data: dataTable,
            columns: [
                { data: 'Sum' },
                { data: 'TransferType' },
                { data: 'UserName' },
                { data: 'OperationDate' }
            ],

            createdRow: function (row, data, index) {
                if (data.Sum < 0) {
                    $('td', row).addClass('red');
                } else {
                    $('td', row).addClass('green');
                }
            }
        });

 //// Sort by column 1 and then re-draw
 //   table
 //       .order( [ 3, 'desc' ] )
 //       .draw();

    function getLogs() {
        var result;

        $.ajax({
            type: 'GET',
            url: baseUrl + '/api/Transaction/GetTransactionLogs',
            beforeSend: function (xhr) {
                const token = sessionStorage.getItem(tokenKey);
                xhr.setRequestHeader("Authorization", "Bearer " + token);
            },
            async: false
        }).success(function (data) {

            result = JSON.parse(data);

        }).fail(function (data) {
            alert(JSON.parse(data.responseText).Message);
        });

        return result;
    }
</script>